// =============================================================================
// TARODAN - COMPLETE Database Schema
// Based on: project.md & schema.md (SINGLE SOURCE OF TRUTH)
// AUDIT REMEDIATION: ALL GAPS CLOSED
// Database: PostgreSQL 16.x
// ORM: Prisma 5.x
// =============================================================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                      String                   @id @default(uuid())
  email                   String                   @unique
  phone                   String?                  @unique
  passwordHash            String                   @map("password_hash")
  displayName             String                   @map("display_name")
  avatarUrl               String?                  @map("avatar_url")
  bio                     String?
  isVerified              Boolean                  @default(false) @map("is_verified")
  isEmailVerified         Boolean                  @default(false) @map("is_email_verified")
  isPhoneVerified         Boolean                  @default(false) @map("is_phone_verified")
  isSeller                Boolean                  @default(false) @map("is_seller")
  sellerType              SellerType?              @map("seller_type")
  taxId                   String?                  @map("tax_id")
  companyName             String?                  @map("company_name")
  fcmToken                String?                  @map("fcm_token")
  isBanned                Boolean                  @default(false) @map("is_banned")
  bannedAt                DateTime?                @map("banned_at")
  bannedReason            String?                  @map("banned_reason")
  bannedBy                String?                  @map("banned_by")
  createdAt               DateTime                 @default(now()) @map("created_at")                @default(now()) @map("created_at")
  updatedAt               DateTime                 @updatedAt @map("updated_at")
  birthDate               DateTime?                @map("birth_date")
  addresses               Address[]
  adminUser               AdminUser?
  collections             Collection[]
  emailVerificationTokens EmailVerificationToken[]
  buyerInvoices           Invoice[]                @relation("BuyerInvoices")
  sellerInvoices          Invoice[]                @relation("SellerInvoices")
  receivedMessages        Message[]                @relation("MessageReceiver")
  sentMessages            Message[]                @relation("MessageSender")
  buyerOffers             Offer[]                  @relation("BuyerOffers")
  sellerOffers            Offer[]                  @relation("SellerOffers")
  buyerOrders             Order[]                  @relation("BuyerOrders")
  sellerOrders            Order[]                  @relation("SellerOrders")
  passwordResetTokens     PasswordResetToken[]
  paymentHolds            PaymentHold[]
  productRatings          ProductRating[]
  products                Product[]                @relation("SellerProducts")
  pushTokens              PushToken[]
  givenRatings            Rating[]                 @relation("RatingGiver")
  receivedRatings         Rating[]                 @relation("RatingReceiver")
  refreshTokens           RefreshToken[]
  assignedTickets         SupportTicket[]          @relation("TicketAssignee")
  supportTickets          SupportTicket[]          @relation("TicketCreator")
  ticketMessages          TicketMessage[]
  initiatedTrades         Trade[]                  @relation("TradeInitiator")
  receivedTrades          Trade[]                  @relation("TradeReceiver")
  twoFactorSecret         TwoFactorSecret?
  following               UserFollow[]             @relation("Followers")
  followers               UserFollow[]             @relation("Following")
  membership              UserMembership?
  wishlist                Wishlist?

  paymentMethods          PaymentMethod[]
  productLikes            ProductLike[]
  collectionLikes         CollectionLike[]
  @@index([email])
  @@index([isSeller])
  @@map("users")
}


model PaymentMethod {
  id          String   @id @default(uuid())
  userId      String   @map("user_id")
  cardBrand   String   @map("card_brand")
  lastFour    String   @map("last_four")
  expiryMonth Int      @map("expiry_month")
  expiryYear  Int      @map("expiry_year")
  isDefault   Boolean  @default(false) @map("is_default")
  tokenId     String?  @map("token_id")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("payment_methods")
}
model TwoFactorSecret {
  id          String   @id @default(uuid())
  userId      String   @unique @map("user_id")
  secret      String
  isEnabled   Boolean  @default(false) @map("is_enabled")
  backupCodes String[] @map("backup_codes")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("two_factor_secrets")
}

model PasswordResetToken {
  id        String    @id @default(uuid())
  userId    String    @map("user_id")
  token     String    @unique
  expiresAt DateTime  @map("expires_at")
  usedAt    DateTime? @map("used_at")
  createdAt DateTime  @default(now()) @map("created_at")
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([expiresAt])
  @@map("password_reset_tokens")
}

model EmailVerificationToken {
  id        String    @id @default(uuid())
  userId    String    @map("user_id")
  token     String    @unique
  email     String
  expiresAt DateTime  @map("expires_at")
  usedAt    DateTime? @map("used_at")
  createdAt DateTime  @default(now()) @map("created_at")
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@map("email_verification_tokens")
}

model RefreshToken {
  id         String    @id @default(uuid())
  userId     String    @map("user_id")
  tokenHash  String    @unique @map("token_hash")
  deviceInfo String?   @map("device_info")
  ipAddress  String?   @map("ip_address")
  expiresAt  DateTime  @map("expires_at")
  revokedAt  DateTime? @map("revoked_at")
  createdAt  DateTime  @default(now()) @map("created_at")
  user       User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([tokenHash])
  @@index([expiresAt])
  @@map("refresh_tokens")
}

model AdminUser {
  id               String         @id @default(uuid())
  userId           String         @unique @map("user_id")
  role             AdminRole
  permissions      Json?
  isActive         Boolean        @default(true) @map("is_active")
  twoFactorEnabled Boolean        @default(false) @map("two_factor_enabled")
  lastLoginAt      DateTime?      @map("last_login_at")
  lastLoginIp      String?        @map("last_login_ip")
  createdAt        DateTime       @default(now()) @map("created_at")
  createdBy        String?        @map("created_by")
  adminSessions    AdminSession[]
  user             User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  auditLogs        AuditLog[]

  @@map("admin_users")
}

model AdminSession {
  id           String    @id @default(uuid())
  adminUserId  String    @map("admin_user_id")
  sessionToken String    @unique @map("session_token")
  ipAddress    String?   @map("ip_address")
  userAgent    String?   @map("user_agent")
  expiresAt    DateTime  @map("expires_at")
  lastActiveAt DateTime  @default(now()) @map("last_active_at")
  createdAt    DateTime  @default(now()) @map("created_at")
  adminUser    AdminUser @relation(fields: [adminUserId], references: [id], onDelete: Cascade)

  @@index([sessionToken])
  @@index([expiresAt])
  @@map("admin_sessions")
}

model Address {
  id             String          @id @default(uuid())
  userId         String          @map("user_id")
  title          String?
  fullName       String          @map("full_name")
  phone          String
  city           String
  district       String
  address        String
  zipCode        String?         @map("zip_code")
  isDefault      Boolean         @default(false) @map("is_default")
  createdAt      DateTime        @default(now()) @map("created_at")
  user           User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  tradeShipments TradeShipment[]

  @@map("addresses")
}

model MembershipTier {
  id                   String             @id @default(uuid())
  type                 MembershipTierType @unique
  name                 String
  description          String?
  monthlyPrice         Decimal            @map("monthly_price") @db.Decimal(10, 2)
  yearlyPrice          Decimal            @map("yearly_price") @db.Decimal(10, 2)
  maxFreeListings      Int                @map("max_free_listings")
  maxTotalListings     Int                @map("max_total_listings")
  maxImagesPerListing  Int                @map("max_images_per_listing")
  canCreateCollections Boolean            @default(false) @map("can_create_collections")
  canTrade             Boolean            @default(false) @map("can_trade")
  isAdFree             Boolean            @default(false) @map("is_ad_free")
  featuredListingSlots Int                @default(0) @map("featured_listing_slots")
  commissionDiscount   Decimal            @default(0) @map("commission_discount") @db.Decimal(5, 4)
  isActive             Boolean            @default(true) @map("is_active")
  sortOrder            Int                @default(0) @map("sort_order")
  createdAt            DateTime           @default(now()) @map("created_at")
  updatedAt            DateTime           @updatedAt @map("updated_at")
  userMemberships      UserMembership[]

  @@map("membership_tiers")
}

model UserMembership {
  id                 String              @id @default(uuid())
  userId             String              @unique @map("user_id")
  tierId             String              @map("tier_id")
  status             SubscriptionStatus  @default(active)
  autoRenew          Boolean             @default(false) @map("auto_renew")
  paymentMethodId    String?             @map("payment_method_id")
  currentPeriodStart DateTime            @map("current_period_start")
  currentPeriodEnd   DateTime            @map("current_period_end")
  cancelledAt        DateTime?           @map("cancelled_at")
  createdAt          DateTime            @default(now()) @map("created_at")
  updatedAt          DateTime            @updatedAt @map("updated_at")
  payments           MembershipPayment[]
  tier               MembershipTier      @relation(fields: [tierId], references: [id])
  user               User                @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@map("user_memberships")
}

model MembershipPayment {
  id                String         @id @default(uuid())
  membershipId      String         @map("membership_id")
  amount            Decimal        @db.Decimal(10, 2)
  provider          String
  providerPaymentId String?        @map("provider_payment_id")
  status            PaymentStatus  @default(pending)
  periodStart       DateTime       @map("period_start")
  periodEnd         DateTime       @map("period_end")
  createdAt         DateTime       @default(now()) @map("created_at")
  membership        UserMembership @relation(fields: [membershipId], references: [id], onDelete: Cascade)

  @@map("membership_payments")
}

model Category {
  id              String           @id @default(uuid())
  name            String           @unique
  slug            String           @unique
  description     String?
  parentId        String?          @map("parent_id")
  sortOrder       Int              @default(0) @map("sort_order")
  isActive        Boolean          @default(true) @map("is_active")
  createdAt       DateTime         @default(now()) @map("created_at")
  parent          Category?        @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children        Category[]       @relation("CategoryHierarchy")
  commissionRules CommissionRule[]
  products        Product[]

  @@map("categories")
}

model Product {
  id                String           @id @default(uuid())
  sellerId          String           @map("seller_id")
  categoryId        String           @map("category_id")
  title             String
  description       String?
  price             Decimal          @db.Decimal(10, 2)
  condition         ProductCondition
  status            ProductStatus    @default(pending)
  isTradeEnabled    Boolean          @default(false) @map("is_trade_enabled")
  viewCount         Int              @default(0) @map("view_count")
  likeCount         Int              @default(0) @map("like_count")
  createdAt         DateTime         @default(now()) @map("created_at")
  updatedAt         DateTime         @updatedAt @map("updated_at")
  version           Int              @default(1)
  collectionItems   CollectionItem[]
  likes             ProductLike[]
  offers            Offer[]
  orders            Order[]
  images            ProductImage[]
  productRatings    ProductRating[]
  category          Category         @relation(fields: [categoryId], references: [id])
  seller            User             @relation("SellerProducts", fields: [sellerId], references: [id])
  tradeItemsOffered TradeItem[]      @relation("TradeItemProduct")
  wishlistItems     WishlistItem[]

  @@index([sellerId])
  @@index([status])
  @@index([isTradeEnabled])
  @@index([createdAt(sort: Desc)])
  @@map("products")
}

model ProductImage {
  id        String   @id @default(uuid())
  productId String   @map("product_id")
  url       String
  minioKey  String?  @map("minio_key")
  sortOrder Int      @default(0) @map("sort_order")
  createdAt DateTime @default(now()) @map("created_at")
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@map("product_images")
}

model ProductLike {
  id        String   @id @default(uuid())
  productId String   @map("product_id")
  userId    String   @map("user_id")
  createdAt DateTime @default(now()) @map("created_at")
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([productId, userId])
  @@index([userId])
  @@map("product_likes")
}

model Trade {
  id                   String            @id @default(uuid())
  tradeNumber          String            @unique @map("trade_number")
  initiatorId          String            @map("initiator_id")
  receiverId           String            @map("receiver_id")
  status               TradeStatus       @default(pending)
  cashAmount           Decimal?          @map("cash_amount") @db.Decimal(10, 2)
  cashPayerId          String?           @map("cash_payer_id")
  cashCommission       Decimal?          @map("cash_commission") @db.Decimal(10, 2)
  initiatorMessage     String?           @map("initiator_message")
  receiverMessage      String?           @map("receiver_message")
  responseDeadline     DateTime          @map("response_deadline")
  paymentDeadline      DateTime?         @map("payment_deadline")
  shippingDeadline     DateTime?         @map("shipping_deadline")
  confirmationDeadline DateTime?         @map("confirmation_deadline")
  acceptedAt           DateTime?         @map("accepted_at")
  completedAt          DateTime?         @map("completed_at")
  cancelledAt          DateTime?         @map("cancelled_at")
  cancelReason         String?           @map("cancel_reason")
  createdAt            DateTime          @default(now()) @map("created_at")
  updatedAt            DateTime          @updatedAt @map("updated_at")
  version              Int               @default(1)
  cashPayment          TradeCashPayment?
  dispute              TradeDispute?
  initiatorItems       TradeItem[]       @relation("TradeInitiatorItems")
  receiverItems        TradeItem[]       @relation("TradeReceiverItems")
  messages             TradeMessage[]
  shipments            TradeShipment[]
  initiator            User              @relation("TradeInitiator", fields: [initiatorId], references: [id])
  receiver             User              @relation("TradeReceiver", fields: [receiverId], references: [id])

  @@index([initiatorId])
  @@index([receiverId])
  @@index([status])
  @@index([responseDeadline])
  @@map("trades")
}

model TradeItem {
  id                   String   @id @default(uuid())
  tradeId              String   @map("trade_id")
  productId            String   @map("product_id")
  side                 String
  quantity             Int      @default(1)
  valueAtTrade         Decimal  @map("value_at_trade") @db.Decimal(10, 2)
  createdAt            DateTime @default(now()) @map("created_at")
  tradeAsInitiatorItem Trade?   @relation("TradeInitiatorItems", fields: [tradeId], references: [id], onDelete: Cascade, map: "trade_initiator_items_fk")
  tradeAsReceiverItem  Trade?   @relation("TradeReceiverItems", fields: [tradeId], references: [id], onDelete: Cascade, map: "trade_receiver_items_fk")
  product              Product  @relation("TradeItemProduct", fields: [productId], references: [id])

  @@index([tradeId])
  @@index([productId])
  @@map("trade_items")
}

model TradeShipment {
  id             String               @id @default(uuid())
  tradeId        String               @map("trade_id")
  shipperId      String               @map("shipper_id")
  fromAddressId  String               @map("from_address_id")
  carrier        String
  trackingNumber String?              @map("tracking_number")
  status         ShipmentStatus       @default(pending)
  shippedAt      DateTime?            @map("shipped_at")
  deliveredAt    DateTime?            @map("delivered_at")
  confirmedAt    DateTime?            @map("confirmed_at")
  createdAt      DateTime             @default(now()) @map("created_at")
  updatedAt      DateTime             @updatedAt @map("updated_at")
  events         TradeShipmentEvent[]
  fromAddress    Address              @relation(fields: [fromAddressId], references: [id])
  trade          Trade                @relation(fields: [tradeId], references: [id], onDelete: Cascade)

  @@index([tradeId])
  @@map("trade_shipments")
}

model TradeShipmentEvent {
  id              String        @id @default(uuid())
  tradeShipmentId String        @map("trade_shipment_id")
  status          String
  description     String?
  location        String?
  eventTime       DateTime      @map("event_time")
  createdAt       DateTime      @default(now()) @map("created_at")
  tradeShipment   TradeShipment @relation(fields: [tradeShipmentId], references: [id], onDelete: Cascade)

  @@map("trade_shipment_events")
}

model TradeCashPayment {
  id                String        @id @default(uuid())
  tradeId           String        @unique @map("trade_id")
  payerId           String        @map("payer_id")
  recipientId       String        @map("recipient_id")
  amount            Decimal       @db.Decimal(10, 2)
  commission        Decimal       @db.Decimal(10, 2)
  totalAmount       Decimal       @map("total_amount") @db.Decimal(10, 2)
  provider          String
  providerPaymentId String?       @map("provider_payment_id")
  status            PaymentStatus @default(pending)
  paidAt            DateTime?     @map("paid_at")
  releasedAt        DateTime?     @map("released_at")
  refundedAt        DateTime?     @map("refunded_at")
  createdAt         DateTime      @default(now()) @map("created_at")
  updatedAt         DateTime      @updatedAt @map("updated_at")
  trade             Trade         @relation(fields: [tradeId], references: [id], onDelete: Cascade)

  @@map("trade_cash_payments")
}

model TradeDispute {
  id              String    @id @default(uuid())
  tradeId         String    @unique @map("trade_id")
  raisedById      String    @map("raised_by_id")
  reason          String
  description     String
  evidence        Json?
  resolution      String?
  resolvedById    String?   @map("resolved_by_id")
  resolvedAt      DateTime? @map("resolved_at")
  resolutionNotes String?   @map("resolution_notes")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")
  trade           Trade     @relation(fields: [tradeId], references: [id], onDelete: Cascade)

  @@map("trade_disputes")
}

model TradeMessage {
  id        String   @id @default(uuid())
  tradeId   String   @map("trade_id")
  senderId  String   @map("sender_id")
  content   String
  createdAt DateTime @default(now()) @map("created_at")
  trade     Trade    @relation(fields: [tradeId], references: [id], onDelete: Cascade)

  @@index([tradeId])
  @@map("trade_messages")
}

model MessageThread {
  id             String    @id @default(uuid())
  participant1Id String    @map("participant1_id")
  participant2Id String    @map("participant2_id")
  productId      String?   @map("product_id")
  lastMessageAt  DateTime  @default(now()) @map("last_message_at")
  createdAt      DateTime  @default(now()) @map("created_at")
  messages       Message[]

  @@unique([participant1Id, participant2Id, productId])
  @@index([participant1Id])
  @@index([participant2Id])
  @@map("message_threads")
}

model Message {
  id              String        @id @default(uuid())
  threadId        String        @map("thread_id")
  senderId        String        @map("sender_id")
  receiverId      String        @map("receiver_id")
  content         String
  filteredContent String?       @map("filtered_content")
  status          MessageStatus @default(sent)
  flaggedReason   String?       @map("flagged_reason")
  reviewedById    String?       @map("reviewed_by_id")
  reviewedAt      DateTime?     @map("reviewed_at")
  readAt          DateTime?     @map("read_at")
  createdAt       DateTime      @default(now()) @map("created_at")
  receiver        User          @relation("MessageReceiver", fields: [receiverId], references: [id])
  sender          User          @relation("MessageSender", fields: [senderId], references: [id])
  thread          MessageThread @relation(fields: [threadId], references: [id], onDelete: Cascade)

  @@index([threadId])
  @@index([senderId])
  @@index([receiverId])
  @@index([status])
  @@map("messages")
}

model ContentFilter {
  id               String   @id @default(uuid())
  filterType       String   @map("filter_type")
  name             String
  pattern          String
  replacement      String   @default("[i√ßerik gizlendi]")
  requiresApproval Boolean  @default(true) @map("requires_approval")
  priority         Int      @default(0)
  isActive         Boolean  @default(true) @map("is_active")
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  @@index([isActive])
  @@map("content_filters")
}

model Rating {
  id         String   @id @default(uuid())
  giverId    String   @map("giver_id")
  receiverId String   @map("receiver_id")
  orderId    String?  @map("order_id")
  tradeId    String?  @map("trade_id")
  score      Int
  comment    String?
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")
  giver      User     @relation("RatingGiver", fields: [giverId], references: [id])
  receiver   User     @relation("RatingReceiver", fields: [receiverId], references: [id])

  @@unique([giverId, orderId])
  @@unique([giverId, tradeId])
  @@index([receiverId])
  @@map("ratings")
}

model ProductRating {
  id                 String   @id @default(uuid())
  productId          String   @map("product_id")
  userId             String   @map("user_id")
  orderId            String   @unique @map("order_id")
  score              Int
  title              String?
  review             String?
  images             String[]
  isVerifiedPurchase Boolean  @default(true) @map("is_verified_purchase")
  helpfulCount       Int      @default(0) @map("helpful_count")
  createdAt          DateTime @default(now()) @map("created_at")
  updatedAt          DateTime @updatedAt @map("updated_at")
  product            Product  @relation(fields: [productId], references: [id])
  user               User     @relation(fields: [userId], references: [id])

  @@unique([productId, userId, orderId])
  @@index([productId])
  @@map("product_ratings")
}

model Wishlist {
  id        String         @id @default(uuid())
  userId    String         @unique @map("user_id")
  createdAt DateTime       @default(now()) @map("created_at")
  updatedAt DateTime       @updatedAt @map("updated_at")
  items     WishlistItem[]
  user      User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("wishlists")
}

model WishlistItem {
  id         String   @id @default(uuid())
  wishlistId String   @map("wishlist_id")
  productId  String   @map("product_id")
  addedAt    DateTime @default(now()) @map("added_at")
  product    Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  wishlist   Wishlist @relation(fields: [wishlistId], references: [id], onDelete: Cascade)

  @@unique([wishlistId, productId])
  @@index([productId])
  @@map("wishlist_items")
}

model Collection {
  id            String           @id @default(uuid())
  userId        String           @map("user_id")
  name          String
  slug          String
  description   String?
  coverImageUrl String?          @map("cover_image_url")
  isPublic      Boolean          @default(true) @map("is_public")
  viewCount     Int              @default(0) @map("view_count")
  likeCount     Int              @default(0) @map("like_count")
  createdAt     DateTime         @default(now()) @map("created_at")
  updatedAt     DateTime         @updatedAt @map("updated_at")
  items         CollectionItem[]
  likes         CollectionLike[]
  user          User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, slug])
  @@index([userId])
  @@index([isPublic])
  @@map("collections")
}

model CollectionItem {
  id           String     @id @default(uuid())
  collectionId String     @map("collection_id")
  productId    String     @map("product_id")
  sortOrder    Int        @default(0) @map("sort_order")
  isFeatured   Boolean    @default(false) @map("is_featured")
  addedAt      DateTime   @default(now()) @map("added_at")
  collection   Collection @relation(fields: [collectionId], references: [id], onDelete: Cascade)
  product      Product    @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([collectionId, productId])
  @@map("collection_items")
}

model CollectionLike {
  id           String     @id @default(uuid())
  collectionId String     @map("collection_id")
  userId       String     @map("user_id")
  createdAt    DateTime   @default(now()) @map("created_at")
  collection   Collection @relation(fields: [collectionId], references: [id], onDelete: Cascade)
  user         User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([collectionId, userId])
  @@index([userId])
  @@map("collection_likes")
}

model SupportTicket {
  id           String          @id @default(uuid())
  ticketNumber String          @unique @map("ticket_number")
  creatorId    String          @map("creator_id")
  assigneeId   String?         @map("assignee_id")
  category     TicketCategory
  priority     TicketPriority  @default(medium)
  status       TicketStatus    @default(open)
  subject      String
  orderId      String?         @map("order_id")
  tradeId      String?         @map("trade_id")
  resolvedAt   DateTime?       @map("resolved_at")
  closedAt     DateTime?       @map("closed_at")
  createdAt    DateTime        @default(now()) @map("created_at")
  updatedAt    DateTime        @updatedAt @map("updated_at")
  assignee     User?           @relation("TicketAssignee", fields: [assigneeId], references: [id])
  creator      User            @relation("TicketCreator", fields: [creatorId], references: [id])
  messages     TicketMessage[]

  @@index([creatorId])
  @@index([status])
  @@index([priority])
  @@map("support_tickets")
}

model TicketMessage {
  id          String        @id @default(uuid())
  ticketId    String        @map("ticket_id")
  senderId    String        @map("sender_id")
  content     String
  isInternal  Boolean       @default(false) @map("is_internal")
  attachments String[]
  createdAt   DateTime      @default(now()) @map("created_at")
  sender      User          @relation(fields: [senderId], references: [id])
  ticket      SupportTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  @@index([ticketId])
  @@map("ticket_messages")
}

model Offer {
  id        String      @id @default(uuid())
  productId String      @map("product_id")
  buyerId   String      @map("buyer_id")
  sellerId  String      @map("seller_id")
  amount    Decimal     @db.Decimal(10, 2)
  status    OfferStatus @default(pending)
  expiresAt DateTime    @map("expires_at")
  createdAt DateTime    @default(now()) @map("created_at")
  updatedAt DateTime    @updatedAt @map("updated_at")
  version   Int         @default(1)
  buyer     User        @relation("BuyerOffers", fields: [buyerId], references: [id])
  product   Product     @relation(fields: [productId], references: [id])
  seller    User        @relation("SellerOffers", fields: [sellerId], references: [id])
  order     Order?

  @@index([productId])
  @@index([status])
  @@map("offers")
}

model Order {
  id                String      @id @default(uuid())
  orderNumber       String      @unique @map("order_number")
  buyerId           String      @map("buyer_id")
  sellerId          String      @map("seller_id")
  productId         String      @map("product_id")
  offerId           String?     @unique @map("offer_id")
  shippingAddressId String?     @map("shipping_address_id")
  totalAmount       Decimal     @map("total_amount") @db.Decimal(10, 2)
  shippingCost      Decimal     @default(0) @map("shipping_cost") @db.Decimal(10, 2)
  commissionAmount  Decimal     @map("commission_amount") @db.Decimal(10, 2)
  status            OrderStatus @default(pending_payment)
  shippingAddress   Json?       @map("shipping_address")
  createdAt         DateTime    @default(now()) @map("created_at")
  updatedAt         DateTime    @updatedAt @map("updated_at")
  version           Int         @default(1)
  invoices          Invoice[]
  buyer             User        @relation("BuyerOrders", fields: [buyerId], references: [id])
  offer             Offer?      @relation(fields: [offerId], references: [id])
  product           Product     @relation(fields: [productId], references: [id])
  seller            User        @relation("SellerOrders", fields: [sellerId], references: [id])
  payment           Payment?
  shipment          Shipment?

  @@index([buyerId])
  @@index([sellerId])
  @@index([status])
  @@map("orders")
}

model Payment {
  id                     String        @id @default(uuid())
  orderId                String        @unique @map("order_id")
  provider               String
  providerPaymentId      String?       @map("provider_payment_id")
  providerConversationId String?       @map("provider_conversation_id")
  amount                 Decimal       @db.Decimal(10, 2)
  currency               String        @default("TRY")
  installmentCount       Int           @default(1) @map("installment_count")
  status                 PaymentStatus @default(pending)
  failureReason          String?       @map("failure_reason")
  metadata               Json?
  paidAt                 DateTime?     @map("paid_at")
  createdAt              DateTime      @default(now()) @map("created_at")
  updatedAt              DateTime      @updatedAt @map("updated_at")
  paymentHold            PaymentHold?
  order                  Order         @relation(fields: [orderId], references: [id])

  @@map("payments")
}

model PaymentHold {
  id         String            @id @default(uuid())
  paymentId  String            @unique @map("payment_id")
  orderId    String            @map("order_id")
  sellerId   String            @map("seller_id")
  amount     Decimal           @db.Decimal(10, 2)
  status     PaymentHoldStatus @default(held)
  releaseAt  DateTime?         @map("release_at")
  releasedAt DateTime?         @map("released_at")
  createdAt  DateTime          @default(now()) @map("created_at")
  updatedAt  DateTime          @updatedAt @map("updated_at")
  payment    Payment           @relation(fields: [paymentId], references: [id])
  seller     User              @relation(fields: [sellerId], references: [id])

  @@map("payment_holds")
}

model Invoice {
  id            String    @id @default(uuid())
  invoiceNumber String    @unique @map("invoice_number")
  orderId       String    @map("order_id")
  buyerId       String    @map("buyer_id")
  sellerId      String    @map("seller_id")
  subtotal      Decimal   @db.Decimal(10, 2)
  taxAmount     Decimal   @default(0) @map("tax_amount") @db.Decimal(10, 2)
  shippingCost  Decimal   @default(0) @map("shipping_cost") @db.Decimal(10, 2)
  total         Decimal   @db.Decimal(10, 2)
  pdfUrl        String?   @map("pdf_url")
  status        String    @default("issued")
  issuedAt      DateTime  @map("issued_at")
  cancelledAt   DateTime? @map("cancelled_at")
  cancelReason  String?   @map("cancel_reason")
  notes         String?
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")
  buyer         User      @relation("BuyerInvoices", fields: [buyerId], references: [id])
  order         Order     @relation(fields: [orderId], references: [id])
  seller        User      @relation("SellerInvoices", fields: [sellerId], references: [id])

  @@index([orderId])
  @@index([buyerId])
  @@index([sellerId])
  @@index([invoiceNumber])
  @@map("invoices")
}

model Shipment {
  id                String          @id @default(uuid())
  orderId           String          @unique @map("order_id")
  provider          String
  trackingNumber    String?         @map("tracking_number")
  trackingUrl       String?         @map("tracking_url")
  labelUrl          String?         @map("label_url")
  cost              Decimal?        @db.Decimal(10, 2)
  status            ShipmentStatus  @default(pending)
  estimatedDelivery DateTime?       @map("estimated_delivery")
  shippedAt         DateTime?       @map("shipped_at")
  deliveredAt       DateTime?       @map("delivered_at")
  createdAt         DateTime        @default(now()) @map("created_at")
  updatedAt         DateTime        @updatedAt @map("updated_at")
  events            ShipmentEvent[]
  order             Order           @relation(fields: [orderId], references: [id])

  @@map("shipments")
}

model ShipmentEvent {
  id          String   @id @default(uuid())
  shipmentId  String   @map("shipment_id")
  status      String
  description String?
  location    String?
  occurredAt  DateTime @map("occurred_at")
  createdAt   DateTime @default(now()) @map("created_at")
  shipment    Shipment @relation(fields: [shipmentId], references: [id], onDelete: Cascade)

  @@map("shipment_events")
}

model CommissionRule {
  id             String              @id @default(uuid())
  name           String
  ruleType       CommissionRuleType  @map("rule_type")
  categoryId     String?             @map("category_id")
  sellerType     SellerType?         @map("seller_type")
  membershipTier MembershipTierType? @map("membership_tier")
  minAmount      Decimal?            @map("min_amount") @db.Decimal(10, 2)
  percentage     Decimal             @db.Decimal(5, 4)
  minCommission  Decimal?            @map("min_commission") @db.Decimal(10, 2)
  maxCommission  Decimal?            @map("max_commission") @db.Decimal(10, 2)
  isActive       Boolean             @default(true) @map("is_active")
  priority       Int                 @default(0)
  createdAt      DateTime            @default(now()) @map("created_at")
  updatedAt      DateTime            @updatedAt @map("updated_at")
  category       Category?           @relation(fields: [categoryId], references: [id])

  @@index([isActive])
  @@map("commission_rules")
}

model PlatformSetting {
  id           String   @id @default(uuid())
  settingKey   String   @unique @map("setting_key")
  settingValue String   @map("setting_value")
  settingType  String   @map("setting_type")
  description  String?
  updatedBy    String?  @map("updated_by")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  @@map("platform_settings")
}

model AuditLog {
  id          String    @id @default(uuid())
  adminUserId String    @map("admin_user_id")
  action      String
  entityType  String    @map("entity_type")
  entityId    String    @map("entity_id")
  oldValue    Json?     @map("old_value")
  newValue    Json?     @map("new_value")
  ipAddress   String?   @map("ip_address")
  userAgent   String?   @map("user_agent")
  createdAt   DateTime  @default(now()) @map("created_at")
  adminUser   AdminUser @relation(fields: [adminUserId], references: [id])

  @@index([adminUserId])
  @@index([entityType, entityId])
  @@index([createdAt])
  @@map("audit_logs")
}

model AnalyticsSnapshot {
  id            String   @id @default(uuid())
  snapshotType  String   @map("snapshot_type")
  snapshotDate  DateTime @map("snapshot_date") @db.Date
  totalUsers    Int?     @map("total_users")
  totalProducts Int?     @map("total_products")
  totalOrders   Int?     @map("total_orders")
  totalTrades   Int?     @map("total_trades")
  totalRevenue  Decimal? @map("total_revenue") @db.Decimal(12, 2)
  newUsers      Int?     @map("new_users")
  newOrders     Int?     @map("new_orders")
  data          Json
  createdAt     DateTime @default(now()) @map("created_at")

  @@unique([snapshotType, snapshotDate])
  @@index([snapshotType, snapshotDate])
  @@map("analytics_snapshots")
}

model MediaFile {
  id         String   @id @default(uuid())
  bucket     String
  key        String   @unique
  filename   String
  mimeType   String   @map("mime_type")
  size       Int
  uploaderId String?  @map("uploader_id")
  entityType String?  @map("entity_type")
  entityId   String?  @map("entity_id")
  isPublic   Boolean  @default(true) @map("is_public")
  url        String
  createdAt  DateTime @default(now()) @map("created_at")

  @@index([bucket])
  @@index([entityType, entityId])
  @@map("media_files")
}

model CsrfToken {
  id        String   @id @default(uuid())
  token     String   @unique
  sessionId String   @map("session_id")
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  @@index([token])
  @@index([sessionId])
  @@map("csrf_tokens")
}

model CacheEntry {
  id        String    @id @default(uuid())
  key       String    @unique
  value     Json
  expiresAt DateTime? @map("expires_at")
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")

  @@index([key])
  @@map("cache_entries")
}

model NotificationLog {
  id           String    @id @default(uuid())
  userId       String    @map("user_id")
  channel      String
  type         String
  title        String
  body         String
  data         Json?
  status       String
  errorMessage String?   @map("error_message")
  sentAt       DateTime? @map("sent_at")
  createdAt    DateTime  @default(now()) @map("created_at")

  @@index([userId])
  @@index([channel])
  @@index([status])
  @@map("notification_logs")
}

model PushToken {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  token     String
  platform  String
  deviceId  String?  @map("device_id")
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, token])
  @@index([userId])
  @@index([token])
  @@map("push_tokens")
}

model SearchIndex {
  id            String    @id @default(uuid())
  indexName     String    @unique @map("index_name")
  documentCount Int       @default(0) @map("document_count")
  lastSyncedAt  DateTime? @map("last_synced_at")
  status        String    @default("active")
  settings      Json?
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  @@map("search_indexes")
}

model UserFollow {
  id          String   @id @default(uuid())
  followerId  String   @map("follower_id")
  followingId String   @map("following_id")
  createdAt   DateTime @default(now()) @map("created_at")
  follower    User     @relation("Followers", fields: [followerId], references: [id], onDelete: Cascade)
  following   User     @relation("Following", fields: [followingId], references: [id], onDelete: Cascade)

  @@unique([followerId, followingId])
  @@index([followerId])
  @@index([followingId])
  @@map("user_follows")
}

// =============================================================================
// ENUMS - COMPLETE LIST
// =============================================================================

enum ProductStatus {
  draft
  pending
  active
  reserved
  sold
  inactive
  rejected
}

enum ProductCondition {
  new
  like_new
  very_good
  good
  fair
}

enum OfferStatus {
  pending
  accepted
  rejected
  expired
  cancelled
}

enum OrderStatus {
  pending_payment
  paid
  preparing
  shipped
  delivered
  completed
  cancelled
  refund_requested
  refunded
}

enum PaymentStatus {
  pending
  processing
  completed
  failed
  refunded
}

enum PaymentHoldStatus {
  held
  released
  cancelled
}

enum ShipmentStatus {
  pending
  label_created
  picked_up
  in_transit
  out_for_delivery
  delivered
  returned
  failed
}

enum AdminRole {
  super_admin
  admin
  moderator
}

enum CommissionRuleType {
  default
  category
  seller_type
  category_seller
}

enum SellerType {
  individual
  verified
  platform
}

// =============================================================================
// GAP-001: TRADE SYSTEM ENUMS (BLOCKER FIX)
// =============================================================================

enum TradeStatus {
  pending // Trade created, awaiting receiver response
  accepted // Receiver accepted, awaiting payment/shipping
  rejected // Receiver declined
  initiator_shipped // Initiator has shipped their items
  receiver_shipped // Receiver has shipped their items
  both_shipped // Both parties have shipped
  initiator_received // Initiator confirmed receipt
  receiver_received // Receiver confirmed receipt
  completed // Both confirmed, trade successful
  cancelled // Trade cancelled (timeout/manual/dispute)
  disputed // Issue raised, admin intervention needed
}

// =============================================================================
// GAP-002: MESSAGE STATUS ENUM (BLOCKER FIX)
// =============================================================================

enum MessageStatus {
  sent // Clean message, delivered immediately
  pending_approval // Flagged, awaiting admin review
  approved // Admin approved, delivered
  rejected // Admin rejected, not delivered
}

// =============================================================================
// GAP-003: MEMBERSHIP TIER ENUM (BLOCKER FIX)
// =============================================================================

enum MembershipTierType {
  free
  basic
  premium
  business
}

enum SubscriptionStatus {
  active
  cancelled
  expired
  past_due
}

// =============================================================================
// GAP-013: SUPPORT TICKET ENUMS (MEDIUM FIX)
// =============================================================================

enum TicketStatus {
  open
  in_progress
  waiting_customer
  resolved
  closed
}

enum TicketPriority {
  low
  medium
  high
  urgent
}

enum TicketCategory {
  payment
  shipping
  trade
  account
  product
  technical
  other
}

